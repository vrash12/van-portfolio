"use strict";

/* ---------------------------------------------------
  Auto-media loading (NO manual filenames in JS):
  We load "./assets/projects.manifest.json"
  which is generated by the Node script in section 3.

  Your folders are inside /assets/ :
    /assets/pgtonboard/
    /assets/fabella/
    /assets/patientcare/
    /assets/gomez/
--------------------------------------------------- */

const PROJECTS = {
  pgtonboard: {
    title: "PGT Onboard",
    meta: "Mobile Application & Internet of Things",
    description:
      "An mobile application and IoT system for public transportation onboarding and monitoring. Integrates GPS tracking, electronic payment, and real-time data for efficient transit management.",

    // ✅ Canva presentation embed
    presentationEmbedUrl:
      "https://www.canva.com/design/DAGlozxycKg/ackA8h_Qu7qxc9V2J0As6Q/view?embed",
    presentationViewUrl:
      "https://www.canva.com/design/DAGlozxycKg/ackA8h_Qu7qxc9V2J0As6Q/view",
  },

  fabella: {
    title: "Fabellacares",
    meta: "Web development",
    description:
      "A web system designed to support healthcare workflows and records. It also includes queue management with trend forecsting and patient tracking features for improved service delivery.",
  },

  patientcare: {
    title: "Patientcare",
    meta: "Web development",
    description:
      "Developed PatientCare, a patient-centric hospital billing system with bill tracking, dispute handling, and cross-department workflow coordination.",
  },

  gomez: {
    title: "Gomez Dental Clinic Management System",
    meta: "Web development",
    description:
      "A clinic management system that supports appointments, patient records, billing, and reporting—designed for smoother daily clinic operations.",
  },
};

const MANIFEST_URL = "./assets/projects.manifest.json";

let manifestCache = null;

function extToType(filename) {
  const lower = filename.toLowerCase();
  if (lower.match(/\.(mp4|webm|mov|m4v)$/)) return "video";
  if (lower.match(/\.(png|jpg|jpeg|webp|gif)$/)) return "image";
  return "other";
}

async function loadManifest() {
  if (manifestCache) return manifestCache;

  const res = await fetch(MANIFEST_URL, { cache: "no-store" });
  if (!res.ok) {
    throw new Error(
      `Cannot load ${MANIFEST_URL}. Generate it (section 3) or make sure it exists.`
    );
  }

  manifestCache = await res.json();
  return manifestCache;
}

/* -----------------------------
  Sidebar toggle (mobile)
------------------------------ */
const sidebar = document.querySelector("[data-sidebar]");
const sidebarBtn = document.querySelector("[data-sidebar-btn]");

if (sidebar && sidebarBtn) {
  sidebarBtn.addEventListener("click", () => {
    sidebar.classList.toggle("active");
  });
}

/* -----------------------------
  Page navigation (navbar) - FIXED
  Uses data-nav="about|resume|portfolio|contact"
------------------------------ */
const navLinks = Array.from(document.querySelectorAll("[data-nav-link]"));
const pages = Array.from(document.querySelectorAll("[data-page]"));

function setActivePage(pageName) {
  const key = (pageName || "").toLowerCase();
  let found = false;

  pages.forEach((page) => {
    const isActive = (page.dataset.page || "").toLowerCase() === key;
    page.classList.toggle("active", isActive);
    if (isActive) found = true;
  });

  return found;
}

function setActiveNav(activeBtn) {
  navLinks.forEach((btn) => btn.classList.toggle("active", btn === activeBtn));
}

if (navLinks.length && pages.length) {
  navLinks.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = (btn.dataset.nav || "").toLowerCase();
      const ok = setActivePage(target);
      if (!ok) return;

      setActiveNav(btn);

      // close sidebar on mobile after nav
      if (sidebar && sidebar.classList.contains("active")) sidebar.classList.remove("active");

      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  });
}

/* -----------------------------
  Portfolio filter
------------------------------ */
const filterBtns = Array.from(document.querySelectorAll("[data-filter-btn]"));
const filterItems = Array.from(document.querySelectorAll("[data-filter-item]"));

const selectBox = document.querySelector("[data-select]");
const selectValue = document.querySelector("[data-selecct-value]"); // keep your spelling
const selectItems = Array.from(document.querySelectorAll("[data-select-item]"));

function applyFilter(category) {
  const cat = (category || "all").toLowerCase();

  filterItems.forEach((item) => {
    const itemCat = (item.dataset.category || "").toLowerCase();
    const show = cat === "all" || itemCat === cat;
    item.classList.toggle("active", show);
  });
}

if (filterBtns.length && filterItems.length) {
  filterBtns.forEach((btn) => {
    btn.addEventListener("click", () => {
      const category = btn.textContent.trim().toLowerCase();

      filterBtns.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      applyFilter(category);
    });
  });
}

if (selectBox && selectValue && selectItems.length) {
  selectBox.addEventListener("click", () => {
    selectBox.classList.toggle("active");
  });

  selectItems.forEach((item) => {
    item.addEventListener("click", () => {
      const category = item.textContent.trim();
      const lower = category.toLowerCase();

      selectValue.textContent = category;
      selectBox.classList.remove("active");

      filterBtns.forEach((b) => {
        b.classList.toggle("active", b.textContent.trim().toLowerCase() === lower);
      });

      applyFilter(lower);
    });
  });
}

/* -----------------------------
  Contact form button enable
------------------------------ */
const form = document.querySelector("[data-form]");
const formInputs = Array.from(document.querySelectorAll("[data-form-input]"));
const formBtn = document.querySelector("[data-form-btn]");

function validateForm() {
  if (!formBtn) return;
  const allFilled = formInputs.every((input) => input.value.trim().length > 0);
  formBtn.disabled = !allFilled;
}

if (form && formInputs.length && formBtn) {
  formInputs.forEach((input) => input.addEventListener("input", validateForm));
  validateForm();
}

/* -----------------------------
  Project modal (gallery + description + Canva)
------------------------------ */
const projectModalContainer = document.querySelector("[data-project-modal-container]");
const projectOverlay = document.querySelector("[data-project-overlay]");
const projectCloseBtn = document.querySelector("[data-project-modal-close]");

const modalTitle = document.querySelector("[data-project-modal-title]");
const modalMeta = document.querySelector("[data-project-modal-meta]");
const modalDesc = document.querySelector("[data-project-modal-desc]");
const mediaGrid = document.querySelector("[data-project-media-grid]");
const embedArea = document.querySelector("[data-project-embed-area]");

function closeProjectModal() {
  if (!projectModalContainer) return;
  projectModalContainer.classList.remove("active");
  document.body.classList.remove("modal-open"); // ✅ prevent background scroll
  mediaGrid.innerHTML = "";
  embedArea.innerHTML = "";
}

if (projectCloseBtn) projectCloseBtn.addEventListener("click", closeProjectModal);
if (projectOverlay) projectOverlay.addEventListener("click", closeProjectModal);

/* -----------------------------
  Viewer (next/prev)
------------------------------ */
const viewer = document.querySelector("[data-viewer]");
const viewerMedia = document.querySelector("[data-viewer-media]");
const viewerCaption = document.querySelector("[data-viewer-caption]");
const viewerPrev = document.querySelector("[data-viewer-prev]");
const viewerNext = document.querySelector("[data-viewer-next]");
const viewerCloseEls = Array.from(document.querySelectorAll("[data-viewer-close]"));

let viewerList = [];
let viewerIndex = 0;

function renderViewer() {
  if (!viewerMedia) return;

  const item = viewerList[viewerIndex];
  if (!item) return;

  viewerMedia.innerHTML = "";
  viewerCaption.textContent = item.caption || "";

  if (item.type === "video") {
    const vid = document.createElement("video");
    vid.controls = true;
    vid.preload = "metadata";
    vid.src = item.src;
    viewerMedia.appendChild(vid);
  } else {
    const img = document.createElement("img");
    img.loading = "eager";
    img.src = item.src;
    img.alt = item.caption || "Project media";
    viewerMedia.appendChild(img);
  }
}

function openViewer(list, index) {
  viewerList = Array.isArray(list) ? list : [];
  viewerIndex = Math.max(0, Math.min(index || 0, viewerList.length - 1));

  if (!viewer || !viewerList.length) return;

  viewer.classList.add("active");
  renderViewer();
}

function closeViewer() {
  if (!viewer) return;
  viewer.classList.remove("active");
  viewerMedia.innerHTML = "";
  viewerCaption.textContent = "";
  viewerList = [];
  viewerIndex = 0;
}

function prevViewer() {
  if (!viewerList.length) return;
  viewerIndex = (viewerIndex - 1 + viewerList.length) % viewerList.length;
  renderViewer();
}

function nextViewer() {
  if (!viewerList.length) return;
  viewerIndex = (viewerIndex + 1) % viewerList.length;
  renderViewer();
}

if (viewerPrev) viewerPrev.addEventListener("click", prevViewer);
if (viewerNext) viewerNext.addEventListener("click", nextViewer);
viewerCloseEls.forEach((el) => el.addEventListener("click", closeViewer));

document.addEventListener("keydown", (e) => {
  if (viewer && viewer.classList.contains("active")) {
    if (e.key === "Escape") closeViewer();
    if (e.key === "ArrowLeft") prevViewer();
    if (e.key === "ArrowRight") nextViewer();
    return;
  }

  if (e.key === "Escape") closeProjectModal();
});

async function openProjectModal(key) {
  const project = PROJECTS[key] || { title: key };
  if (!projectModalContainer) return;

  modalTitle.textContent = project.title || "Project";
  modalMeta.textContent = project.meta || "";
  modalDesc.textContent = project.description || "";

  mediaGrid.innerHTML = "";
  embedArea.innerHTML = "";

  // Canva presentation (only for pgtonboard right now)
  if (project.presentationEmbedUrl) {
    const wrap = document.createElement("div");

    wrap.innerHTML = `
      <div class="embed-wrap">
        <iframe
          loading="lazy"
          src="${project.presentationEmbedUrl}"
          allowfullscreen="allowfullscreen"
          allow="fullscreen">
        </iframe>
      </div>
      <div class="embed-actions">
        <a class="form-btn" href="${project.presentationViewUrl || project.presentationEmbedUrl}" target="_blank" rel="noopener">
          View Presentation (Canva)
        </a>
      </div>
    `;
    embedArea.appendChild(wrap);
  }

  // Load all media from manifest
  let files = [];
  try {
    const manifest = await loadManifest();
    files = Array.isArray(manifest[key]) ? manifest[key] : [];
  } catch (err) {
    console.error(err);
    // show message inside modal
    const msg = document.createElement("p");
    msg.className = "project-modal-meta";
    msg.textContent = "Media list not found. Generate assets/projects.manifest.json (see section 3).";
    mediaGrid.appendChild(msg);
  }

  // Build gallery + viewer list
  const listForViewer = [];

  files.forEach((relPath) => {
    const type = extToType(relPath);
    if (type === "other") return;

    const src = `./assets/${key}/${relPath}`.replaceAll("\\", "/");
    const caption = relPath;

    listForViewer.push({ type, src, caption });
  });

  if (!listForViewer.length) {
    const empty = document.createElement("p");
    empty.className = "project-modal-meta";
    empty.textContent = "No images/videos found for this project folder.";
    mediaGrid.appendChild(empty);
  } else {
    listForViewer.forEach((m, idx) => {
      const cell = document.createElement("div");

      const btn = document.createElement("button");
      btn.type = "button";
      btn.addEventListener("click", () => openViewer(listForViewer, idx));

      if (m.type === "video") {
        const vid = document.createElement("video");
        vid.preload = "metadata";
        vid.src = m.src;
        vid.muted = true;
        vid.playsInline = true;
        btn.appendChild(vid);
      } else {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.src = m.src;
        img.alt = m.caption || project.title || "Project image";
        btn.appendChild(img);
      }

      cell.appendChild(btn);
      mediaGrid.appendChild(cell);
    });
  }

  projectModalContainer.classList.add("active");
  document.body.classList.add("modal-open"); // ✅ prevent background scroll
}

/* Attach click handlers to projects */
document.querySelectorAll("[data-project] a").forEach((a) => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const li = a.closest("[data-project]");
    if (!li) return;
    openProjectModal(li.dataset.project).catch(console.error);
  });
});
